<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Free Will Synthesis Survey - A research survey about beliefs in free will, determinism, and related concepts">
    <title>Free Will Synthesis Survey</title>
    <style>
        :root {
            /* Light theme variables */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #2d3436;
            --text-secondary: #636e72;
            --accent-color: #0984e3;
            --border-color: #dfe6e9;
            --error-color: #d63031;
            --success-color: #00b894;
            --fieldset-bg: #ffffff;
            --select-bg: #ffffff;
            --select-border: #b2bec3;
            --button-bg: #0984e3;
            --button-text: #ffffff;
            --button-hover: #0870c0;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            /* Dark theme variables */
            --bg-primary: #2d3436;
            --bg-secondary: #222831;
            --text-primary: #f5f6fa;
            --text-secondary: #dcdde1;
            --accent-color: #00a8ff;
            --border-color: #4a4f54;
            --error-color: #ff6b6b;
            --success-color: #1dd1a1;
            --fieldset-bg: #353b48;
            --select-bg: #2d3436;
            --select-border: #576574;
            --button-bg: #00a8ff;
            --button-text: #ffffff;
            --button-hover: #0097e6;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        header {
            background-color: var(--bg-secondary);
            padding: 2rem;
            text-align: center;
            box-shadow: 0 2px 4px var(--shadow-color);
            position: relative;
        }

        .theme-switch {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .theme-switch button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            color: var(--text-primary);
        }

        .theme-switch button:hover {
            background-color: var(--shadow-color);
        }

        main {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }

        fieldset {
            background-color: var(--fieldset-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        legend {
            color: var(--accent-color);
            font-weight: bold;
            padding: 0 0.5rem;
        }

        .question {
            margin-bottom: 1.5rem;
            transform: translateY(0);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .question:hover {
            transform: translateY(-2px);
        }

        .question.answered {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        .answer-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .answer-option {
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: var(--bg-primary);
            position: relative;
            overflow: hidden;
        }

        .answer-option:hover {
            border-color: var(--accent-color);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        .answer-option.selected {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            transform: scale(1.05);
        }

        .answer-option::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background-color: var(--accent-color);
            opacity: 0.3;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
        }

        .answer-option:active::before {
            width: 200%;
            height: 200%;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .question.highlight {
            animation: pulse 0.6s ease;
        }

        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: 4px;
            background-color: var(--accent-color);
            transition: width 0.3s ease;
            z-index: 1000;
        }

        .fieldset-progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .progress-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--border-color);
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        .progress-dot.active {
            background-color: var(--accent-color);
            transform: scale(1.2);
        }

        @media (max-width: 600px) {
            .answer-grid {
                grid-template-columns: repeat(5, 1fr);
                font-size: 0.9rem;
            }
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--select-border);
            border-radius: 4px;
            background-color: var(--select-bg);
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(9, 132, 227, 0.2);
        }

        .form-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            background-color: var(--button-bg);
            color: var(--button-text);
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: var(--button-hover);
        }

        button[type="reset"] {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        button[type="reset"]:hover {
            background-color: var(--border-color);
        }

        .alert {
            background-color: var(--error-color);
            color: white;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        #results {
            background-color: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 2rem;
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        #results h2 {
            color: var(--accent-color);
            margin-bottom: 1rem;
        }

        #results p {
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        footer {
            text-align: center;
            padding: 2rem;
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
            margin-top: 2rem;
        }

        @media (max-width: 600px) {
            main {
                padding: 1rem;
            }
            
            fieldset {
                padding: 1rem;
            }
            
            .form-controls {
                flex-direction: column;
            }
            
            .theme-switch {
                position: static;
                justify-content: center;
                margin-top: 1rem;
            }
        }

        .alert.success {
            background-color: var(--success-color);
            color: white;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .alert.error {
            background-color: var(--error-color);
            color: white;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .popup-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--error-color);
            color: white;
            padding: 1.5rem 3rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow-color);
            z-index: 1000;
            animation: fadeInOutLonger 2s ease-in-out forwards;
            text-align: center;
            font-weight: bold;
            opacity: 0;
        }

        @keyframes fadeInOutLonger {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            10% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
        }

        .timer {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background-color: var(--bg-secondary);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            box-shadow: 0 2px 4px var(--shadow-color);
            font-family: monospace;
            font-size: 1.1rem;
            color: var(--text-primary);
            z-index: 100;
        }

        @media (max-width: 600px) {
            .timer {
                position: static;
                margin: 1rem auto;
                width: fit-content;
            }
        }

        .modern-footer {
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
            padding: 3rem 2rem;
            margin-top: 4rem;
            box-shadow: 0 -2px 10px var(--shadow-color);
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 2rem;
            align-items: center;
        }

        .footer-left, .footer-center, .footer-right {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .footer-center {
            text-align: center;
        }

        .footer-right {
            text-align: right;
        }

        .social-links {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .social-link {
            color: var(--text-secondary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            padding: 0.5rem;
            border-radius: 8px;
        }

        .social-link:hover {
            color: var(--accent-color);
            background-color: var(--bg-primary);
            transform: translateY(-2px);
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        .social-link i {
            font-size: 1.2rem;
        }

        .footer-divider {
            width: 100%;
            height: 1px;
            background-color: var(--border-color);
            margin: 2rem 0;
        }

        .footer-bottom {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .footer-content {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .footer-right {
                text-align: center;
            }

            .social-links {
                justify-content: center;
            }
        }

        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }

        .welcome-content {
            text-align: center;
            max-width: 600px;
            padding: 2rem;
            border-radius: 12px;
            background: var(--bg-secondary);
            box-shadow: 0 8px 32px var(--shadow-color);
            transform: translateY(0);
            transition: transform 0.5s ease-out;
        }

        .welcome-content.hide {
            transform: translateY(-20px);
        }

        .welcome-overlay.hide {
            opacity: 0;
            pointer-events: none;
        }

        .progress-indicator-container {
            position: fixed;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            z-index: 100;
        }

        .section-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .section-indicator:hover::after {
            content: attr(data-section);
            position: absolute;
            left: 24px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-secondary);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
            white-space: nowrap;
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .section-indicator.active {
            background: var(--accent-color);
            transform: scale(1.2);
        }

        .floating-help {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--accent-color);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px var(--shadow-color);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .floating-help:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--shadow-color);
        }

        .help-tooltip {
            position: absolute;
            bottom: 100%;
            right: 0;
            width: 250px;
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow-color);
            margin-bottom: 1rem;
            display: none;
        }

        .floating-help:hover .help-tooltip {
            display: block;
        }

        .keyboard-shortcuts {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow-color);
            display: none;
            z-index: 100;
        }

        .keyboard-shortcuts.show {
            display: block;
        }

        .shortcut-key {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            background: var(--bg-primary);
            border-radius: 4px;
            margin: 0 0.2rem;
            font-family: monospace;
            border: 1px solid var(--border-color);
        }

        @media (max-width: 768px) {
            .progress-indicator-container {
                display: none;
            }
        }
    </style>
    <link rel="stylesheet" href="styles.css">
    <script src="scripts.js" defer></script>
    <!-- Add debug mode toggle -->
    <script>
        const DEBUG = false; // Set to true to enable debug mode
        
        function logDebug(message) {
            if (DEBUG) {
                console.log(`[DEBUG] ${message}`);
            }
        }

        function validateForm(event) {
            event.preventDefault();
            logDebug('Form submission attempted');
            
            const form = document.getElementById('survey-form');
            const allSelects = form.querySelectorAll('select');
            let isValid = true;
            let responses = {};

            allSelects.forEach(select => {
                if (!select.value) {
                    isValid = false;
                    select.classList.add('error');
                    logDebug(`Question ${select.id} is not answered`);
                } else {
                    select.classList.remove('error');
                    responses[select.id] = parseInt(select.value);
                }
            });

            if (isValid) {
                logDebug('Form is valid. Responses:', responses);
                calculateScores(responses);
                return true;
            } else {
                showPopupAlert('Please answer all questions before submitting');
                document.getElementById('error-message').style.display = 'block';
                return false;
            }
        }

        function calculateScores(responses) {
            // Updated question groupings with new numbering
            const subscales = {
                philosophical: ['q1', 'q2'],
                freeWill: ['q3', 'q4', 'q5', 'q6', 'q7', 'q8', 'q9'],
                determinism: ['q10', 'q11'],
                randomness: ['q12', 'q13', 'q14', 'q15', 'q16', 'q17']
            };

            const scores = {};
            for (const [scale, questions] of Object.entries(subscales)) {
                scores[scale] = calculateMean(responses, questions);
            }

            // Calculate interpretations based on scores
            const interpretations = {
                philosophical: interpretPhilosophicalScore(scores.philosophical),
                freeWill: interpretFreeWillScore(scores.freeWill),
                determinism: interpretDeterminismScore(scores.determinism),
                randomness: interpretRandomnessScore(scores.randomness)
            };

            logDebug('Calculated scores:', scores);
            
            const surveyData = {
                responses: responses,
                scores: scores,
                interpretations: interpretations,
                metadata: {
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    language: navigator.language
                }
            };

            submitToBackend(surveyData);
        }

        function interpretFreeWillScore(score) {
            if (score >= 4) return "Strong belief in free will";
            if (score >= 3) return "Moderate belief in free will";
            return "Limited belief in free will";
        }

        function interpretRandomnessScore(score) {
            if (score >= 4) return "Strong belief in randomness";
            if (score >= 3) return "Moderate belief in randomness";
            return "Limited belief in randomness";
        }

        function interpretDeterminismScore(score) {
            if (score >= 4) return "Strong belief in determinism";
            if (score >= 3) return "Moderate belief in determinism";
            return "Limited belief in determinism";
        }

        function interpretPhilosophicalScore(score) {
            if (score >= 4) return "Strong philosophical understanding";
            if (score >= 3) return "Moderate philosophical understanding";
            return "Basic philosophical understanding";
        }

        function displayResults(scores, interpretations) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <h2>Survey Results</h2>
                <div class="score-section">
                    <h3>Free Will</h3>
                    <p>Score: ${scores.freeWill}</p>
                    <p>Interpretation: ${interpretations.freeWill}</p>
                </div>
                <div class="score-section">
                    <h3>Randomness</h3>
                    <p>Score: ${scores.randomness}</p>
                    <p>Interpretation: ${interpretations.randomness}</p>
                </div>
                <div class="score-section">
                    <h3>Determinism</h3>
                    <p>Score: ${scores.determinism}</p>
                    <p>Interpretation: ${interpretations.determinism}</p>
                </div>
                <div class="score-section">
                    <h3>Philosophical Understanding</h3>
                    <p>Score: ${scores.philosophical}</p>
                    <p>Interpretation: ${interpretations.philosophical}</p>
                </div>
            `;
            resultsDiv.style.display = 'block';
            
            // Scroll to results
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
            logDebug('Results displayed to user');
        }

        // Local Storage Keys
        const STORAGE_KEYS = {
            RESPONSES: 'survey_responses',
            STATS: 'survey_stats'
        };

        // Initialize storage if not exists
        function initializeStorage() {
            if (!localStorage.getItem(STORAGE_KEYS.RESPONSES)) {
                localStorage.setItem(STORAGE_KEYS.RESPONSES, JSON.stringify([]));
            }
            if (!localStorage.getItem(STORAGE_KEYS.STATS)) {
                localStorage.setItem(STORAGE_KEYS.STATS, JSON.stringify({
                    totalResponses: 0,
                    averageScores: {},
                    lastResponse: null
                }));
            }
            logDebug('Storage initialized');
        }

        // Save response to local storage
        function saveResponse(data) {
            try {
                // Get existing responses
                const responses = JSON.parse(localStorage.getItem(STORAGE_KEYS.RESPONSES) || '[]');
                
                // Add new response
                responses.push({
                    id: responses.length + 1,
                    ...data,
                    timestamp: new Date().toISOString()
                });

                // Save updated responses
                localStorage.setItem(STORAGE_KEYS.RESPONSES, JSON.stringify(responses));
                
                // Update stats
                updateStats(responses);
                
                // Export to CSV
                exportToCSV(responses);
                
                logDebug('Response saved successfully');
                return true;
            } catch (error) {
                logDebug('Error saving response:', error);
                return false;
            }
        }

        // Update statistics
        function updateStats(responses) {
            const stats = {
                totalResponses: responses.length,
                averageScores: calculateAverageScores(responses),
                lastResponse: responses[responses.length - 1]?.timestamp
            };
            localStorage.setItem(STORAGE_KEYS.STATS, JSON.stringify(stats));
            logDebug('Stats updated');
        }

        // Calculate average scores
        function calculateAverageScores(responses) {
            const totals = {};
            const counts = {};

            responses.forEach(response => {
                Object.entries(response.scores).forEach(([key, value]) => {
                    totals[key] = (totals[key] || 0) + parseFloat(value);
                    counts[key] = (counts[key] || 0) + 1;
                });
            });

            const averages = {};
            Object.keys(totals).forEach(key => {
                averages[key] = (totals[key] / counts[key]).toFixed(2);
            });

            return averages;
        }

        // Export to CSV
        function exportToCSV(responses) {
            try {
                // Prepare CSV headers
                const headers = [
                    'id',
                    'timestamp',
                    ...Object.keys(responses[0]?.responses || {}).map(q => `response_${q}`),
                    ...Object.keys(responses[0]?.scores || {}).map(s => `score_${s}`),
                    'completionTime',
                    'userAgent',
                    'language'
                ];

                // Prepare CSV rows
                const rows = responses.map(r => [
                    r.id,
                    r.timestamp,
                    ...Object.values(r.responses),
                    ...Object.values(r.scores),
                    r.metadata.completionTimeFormatted,
                    r.metadata.userAgent,
                    r.metadata.language
                ]);

                // Create CSV content
                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.join(','))
                ].join('\n');

                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `survey_responses_${new Date().toISOString()}.csv`;
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                logDebug('CSV exported successfully');
            } catch (error) {
                logDebug('Error exporting CSV:', error);
            }
        }

        // Update the existing submitToBackend function
        async function submitToBackend(data) {
            const currentTime = new Date();
            const elapsedMilliseconds = currentTime - startTime;
            data.metadata.completionTimeMs = elapsedMilliseconds;
            data.metadata.completionTimeFormatted = `${Math.floor(elapsedMilliseconds/60000)}:${((elapsedMilliseconds%60000)/1000).toFixed(0).padStart(2,'0')}`;

            try {
                // Show loading state
                const submitButton = document.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = 'Submitting...';

                // Save to local storage instead of sending to server
                const saved = saveResponse(data);

                if (!saved) {
                    throw new Error('Failed to save response');
                }

                // Display results to user
                displayResults(data.scores, data.interpretations);
                
                // Show success message
                showAlert('Survey submitted successfully! Thank you for participating.', 'success');
                
                // Disable form submission
                document.getElementById('survey-form').querySelector('button[type="submit"]').disabled = true;

                // Add download button for individual response
                addDownloadButton(data);

            } catch (error) {
                logDebug('Error submitting survey:', error);
                showAlert('There was an error submitting your survey. Please try again later.', 'error');
                submitButton.disabled = false;
                submitButton.textContent = 'Submit Survey';
            }
        }

        // Add download button for individual response
        function addDownloadButton(data) {
            const downloadButton = document.createElement('button');
            downloadButton.textContent = 'Download Your Response';
            downloadButton.className = 'download-button';
            downloadButton.onclick = () => {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `survey_response_${new Date().toISOString()}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
            document.getElementById('results').appendChild(downloadButton);
        }

        function showAlert(message, type = 'error') {
            // Remove any existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());

            // Create and show new alert
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            document.getElementById('survey-form').insertAdjacentElement('beforebegin', alert);

            // Auto-hide alert after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function calculateMean(responses, questions) {
            const sum = questions.reduce((acc, q) => acc + (responses[q] || 0), 0);
            return (sum / questions.length).toFixed(2);
        }

        // Theme toggle functionality
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            logDebug(`Theme switched to ${newTheme} mode`);
        }

        // Initialize theme
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            logDebug(`Theme initialized to ${savedTheme} mode`);
        });

        // Initialize debug features when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            logDebug('Survey initialized');
            document.getElementById('survey-form').addEventListener('submit', validateForm);
        });

        function showPopupAlert(message) {
            // Remove any existing popup
            const existingPopup = document.querySelector('.popup-alert');
            if (existingPopup) {
                existingPopup.remove();
            }

            // Create and show new popup
            const popup = document.createElement('div');
            popup.className = 'popup-alert';
            popup.textContent = message;
            document.body.appendChild(popup);

            // Remove popup after animation completes (2 seconds)
            setTimeout(() => {
                popup.remove();
            }, 2000);
        }

        // Timer functionality
        let startTime;
        let timerInterval;

        function startTimer() {
            startTime = new Date();
            const timerElement = document.createElement('div');
            timerElement.className = 'timer';
            timerElement.id = 'survey-timer';
            document.body.appendChild(timerElement);

            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            const currentTime = new Date();
            const elapsedTime = new Date(currentTime - startTime);
            const minutes = elapsedTime.getMinutes().toString().padStart(2, '0');
            const seconds = elapsedTime.getSeconds().toString().padStart(2, '0');
            
            const timerElement = document.getElementById('survey-timer');
            if (timerElement) {
                timerElement.textContent = `Time: ${minutes}:${seconds}`;
            }
        }

        function initializeEnhancedUI() {
            // Create progress bar
            const progressBar = document.createElement('div');
            progressBar.className = 'progress-bar';
            document.body.appendChild(progressBar);

            // Replace all select elements with custom answer grids
            document.querySelectorAll('select').forEach(select => {
                const question = select.closest('.question');
                const answerId = select.id;
                
                // Create answer grid
                const answerGrid = document.createElement('div');
                answerGrid.className = 'answer-grid';
                
                // Create answer options
                for (let i = 1; i <= 5; i++) {
                    const option = document.createElement('div');
                    option.className = 'answer-option';
                    option.textContent = i;
                    option.setAttribute('data-value', i);
                    option.onclick = () => selectAnswer(answerId, i, option, question);
                    answerGrid.appendChild(option);
                }
                
                // Replace select with grid
                select.replaceWith(answerGrid);
            });

            // Add progress indicators to fieldsets
            document.querySelectorAll('fieldset').forEach(fieldset => {
                const questions = fieldset.querySelectorAll('.question');
                const progress = document.createElement('div');
                progress.className = 'fieldset-progress';
                progress.innerHTML = `
                    <span>${fieldset.querySelector('legend').textContent}</span>
                    <div class="progress-indicator">
                        <span>0/${questions.length}</span>
                        <div class="progress-dot"></div>
                    </div>
                `;
                fieldset.insertBefore(progress, fieldset.firstChild);
            });

            updateProgress();
        }

        function selectAnswer(questionId, value, selectedOption, questionDiv) {
            // Remove previous selection
            questionDiv.querySelectorAll('.answer-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Add new selection
            selectedOption.classList.add('selected');
            questionDiv.classList.add('answered');
            
            // Store the answer
            const responses = getStoredResponses();
            responses[questionId] = value;
            localStorage.setItem('current_responses', JSON.stringify(responses));
            
            // Highlight next unanswered question
            highlightNextUnanswered();
            
            // Update progress
            updateProgress();
        }

        function getStoredResponses() {
            return JSON.parse(localStorage.getItem('current_responses') || '{}');
        }

        function updateProgress() {
            const totalQuestions = document.querySelectorAll('.question').length;
            const answeredQuestions = document.querySelectorAll('.question.answered').length;
            const progressPercent = (answeredQuestions / totalQuestions) * 100;
            
            // Update progress bar
            document.querySelector('.progress-bar').style.width = `${progressPercent}%`;
            
            // Update fieldset progress
            document.querySelectorAll('fieldset').forEach(fieldset => {
                const totalInSection = fieldset.querySelectorAll('.question').length;
                const answeredInSection = fieldset.querySelectorAll('.question.answered').length;
                const progressIndicator = fieldset.querySelector('.progress-indicator span');
                const progressDot = fieldset.querySelector('.progress-dot');
                
                progressIndicator.textContent = `${answeredInSection}/${totalInSection}`;
                if (answeredInSection === totalInSection) {
                    progressDot.classList.add('active');
                } else {
                    progressDot.classList.remove('active');
                }
            });
        }

        function highlightNextUnanswered() {
            const unanswered = document.querySelector('.question:not(.answered)');
            if (unanswered) {
                unanswered.classList.add('highlight');
                unanswered.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => {
                    unanswered.classList.remove('highlight');
                }, 600);
            }
        }

        // Welcome overlay
        function showWelcomeScreen() {
            const overlay = document.createElement('div');
            overlay.className = 'welcome-overlay';
            overlay.innerHTML = `
                <div class="welcome-content">
                    <h2>Welcome to the Free Will Synthesis Survey</h2>
                    <p>This survey will help us understand your beliefs about free will, determinism, and randomness.</p>
                    <p>Take your time and answer thoughtfully.</p>
                    <button onclick="startSurvey()" class="start-button">Begin Survey</button>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function startSurvey() {
            const overlay = document.querySelector('.welcome-overlay');
            const content = document.querySelector('.welcome-content');
            content.classList.add('hide');
            overlay.classList.add('hide');
            setTimeout(() => overlay.remove(), 500);
        }

        // Section indicators
        function createSectionIndicators() {
            const container = document.createElement('div');
            container.className = 'progress-indicator-container';
            
            document.querySelectorAll('fieldset').forEach((fieldset, index) => {
                const indicator = document.createElement('div');
                indicator.className = 'section-indicator';
                indicator.setAttribute('data-section', fieldset.querySelector('legend').textContent);
                indicator.onclick = () => scrollToSection(fieldset);
                container.appendChild(indicator);
            });
            
            document.body.appendChild(container);
            updateSectionIndicators();
        }

        function updateSectionIndicators() {
            const indicators = document.querySelectorAll('.section-indicator');
            const sections = document.querySelectorAll('fieldset');
            
            const scrollPosition = window.scrollY + window.innerHeight / 2;
            
            sections.forEach((section, index) => {
                const rect = section.getBoundingClientRect();
                if (rect.top < window.innerHeight / 2 && rect.bottom > window.innerHeight / 2) {
                    indicators[index].classList.add('active');
                } else {
                    indicators[index].classList.remove('active');
                }
            });
        }

        function scrollToSection(section) {
            section.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.key === '?' && e.shiftKey) {
                    toggleShortcutsPanel();
                }
                if (e.key === 'n') {
                    highlightNextUnanswered();
                }
                if (e.key === 'Escape') {
                    hideShortcutsPanel();
                }
            });
        }

        function toggleShortcutsPanel() {
            let panel = document.querySelector('.keyboard-shortcuts');
            if (!panel) {
                panel = document.createElement('div');
                panel.className = 'keyboard-shortcuts';
                panel.innerHTML = `
                    <h3>Keyboard Shortcuts</h3>
                    <p><span class="shortcut-key">Shift</span> + <span class="shortcut-key">?</span> Show/hide this panel</p>
                    <p><span class="shortcut-key">N</span> Jump to next unanswered question</p>
                    <p><span class="shortcut-key">Esc</span> Close panels</p>
                    <p><span class="shortcut-key">1-5</span> Select answer for current question</p>
                `;
                document.body.appendChild(panel);
            }
            panel.classList.toggle('show');
        }

        function hideShortcutsPanel() {
            const panel = document.querySelector('.keyboard-shortcuts');
            if (panel) {
                panel.classList.remove('show');
            }
        }

        // Floating help button
        function addFloatingHelp() {
            const help = document.createElement('div');
            help.className = 'floating-help';
            help.innerHTML = `
                <i class="fas fa-question"></i>
                <div class="help-tooltip">
                    <h4>Need Help?</h4>
                    <p>• Click numbers to select your answer</p>
                    <p>• Use keyboard shortcuts (Shift + ? to view)</p>
                    <p>• Click section indicators to navigate</p>
                </div>
            `;
            document.body.appendChild(help);
        }

        // Update the DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', () => {
            initializeStorage();
            startTimer();
            initializeEnhancedUI();
            showWelcomeScreen();
            createSectionIndicators();
            setupKeyboardShortcuts();
            addFloatingHelp();
            
            window.addEventListener('scroll', updateSectionIndicators);
        });
    </script>
    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header>
        <!-- Timer will be inserted here by JavaScript -->
        <div class="theme-switch">
            <button type="button" onclick="toggleTheme()" aria-label="Toggle theme">
                🌓
            </button>
        </div>
        <h1>Free Will Synthesis Survey</h1>
        <div id="debug-panel" style="display: none;">
            <p>Debug Mode: Active</p>
            <button onclick="console.clear()">Clear Console</button>
        </div>
    </header>
    <main>
        <section id="instructions" aria-label="Survey Instructions">
            <p>For each statement below, choose a number from 1 to 5 to indicate how much you agree or disagree:</p>
            <ul>
                <li><strong>1</strong> - Strongly Disagree</li>
                <li><strong>2</strong> - Disagree</li>
                <li><strong>3</strong> - Neutral</li>
                <li><strong>4</strong> - Agree</li>
                <li><strong>5</strong> - Strongly Agree</li>
            </ul>
        </section>
        
        <div id="error-message" class="alert" style="display: none;" role="alert">
            Please answer all questions before submitting.
        </div>

        <form id="survey-form" novalidate>
            <!-- Group questions by category for better organization -->
            <fieldset>
                <legend>Philosophical Concepts</legend>
                <div class="question">
                    <label for="q1">1. Free will is the ability to make different choices even if everything leading up to one's choice (e.g., the past, the situation, and their desires, beliefs, etc.) were exactly the same.</label>
                    <select id="q1" name="q1" required>
                        <option value="">Select</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <div class="question">
                    <label for="q2">2. To have free will is to be able to cause things to happen in the world without at the same time being caused to make those things happen.</label>
                    <select id="q2" name="q2" required>
                        <option value="">Select</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
            </fieldset>

            <fieldset>
                <legend>Free Will Beliefs</legend>
                <div class="question">
                    <label for="q3">3. People have complete control over the decisions they make.</label>
                    <select id="q3" name="q3" required>
                        <option value="">Select</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <div class="question">
                    <label for="q4">4. People must take full responsibility for any bad choices they make.</label>
                    <select id="q4" name="q4" required>
                        <option value="">Select</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <div class="question">
                    <label for="q5">5. People can overcome any obstacles if they truly want to.</label>
                    <select id="q5" name="q5" required>
                        <option value="">Select</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <div class="question">
                    <label for="q6">6. Criminals are totally responsible for the bad things they do.</label>
                    <select id="q6" name="q6" required>
                        <option value="">Select</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <div class="question">
                    <label for="q7">7. People have complete free will.</label>
                    <select id="q7" name="q7" required>
                        <option value="">Select</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <div class="question">
                    <label for="q8">8. People are always at fault for their bad behavior.</label>
                    <select id="q8" name="q8" required>
                        <option value="">Select</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <div class="question">
                    <label for="q9">9. Strength of mind can always overcome the body's desires.</label>
                    <select id="q9" name="q9" required>
                        <option value="">Select</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
            </fieldset>

            <fieldset>
                <legend>Determinism</legend>
                <div class="question">
                    <label for="q10">10. People's biological makeup determines their talents and personality.</label>
                    <select id="q10" name="q10" required>
                        <option value="">Select</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <div class="question">
                    <label for="q11">11. Childhood environment will determine your success as an adult.</label>
                    <select id="q11" name="q11" required>
                        <option value="">Select</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
            </fieldset>

            <fieldset>
                <legend>Randomness and Unpredictability</legend>
                <div class="question">
                    <label for="q12">12. Chance events seem to be the major cause of human history.</label>
                    <select id="q12" name="q12" required>
                        <option value="">Select</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <div class="question">
                    <label for="q13">13. No one can predict what will happen in this world.</label>
                    <select id="q13" name="q13" required>
                        <option value="">Select</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <div class="question">
                    <label for="q14">14. Life seems unpredictable - just like throwing dice or flipping a coin.</label>
                    <select id="q14" name="q14" required>
                        <option value="">Select</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <div class="question">
                    <label for="q15">15. People are unpredictable.</label>
                    <select id="q15" name="q15" required>
                        <option value="">Select</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <div class="question">
                    <label for="q16">16. Life is hard to predict because it is almost totally random.</label>
                    <select id="q16" name="q16" required>
                        <option value="">Select</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <div class="question">
                    <label for="q17">17. Luck plays a big role in people's lives.</label>
                    <select id="q17" name="q17" required>
                        <option value="">Select</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
            </fieldset>

            <div class="form-controls">
                <button type="submit" aria-label="Submit survey responses">Submit Survey</button>
                <button type="reset" aria-label="Clear all responses">Clear Form</button>
            </div>
        </form>

        <div id="results" style="display: none;" aria-live="polite">
            <!-- Results will be populated by JavaScript -->
        </div>
    </main>
    <footer class="modern-footer">
        <div class="footer-content">
            <div class="footer-left">
                <h3>Free Will Synthesis Survey</h3>
                <p>A research survey about beliefs in free will, determinism, and related philosophical concepts.</p>
            </div>
            
            <div class="footer-center">
                <div class="social-links">
                    <a href="https://github.com/Exios66" class="social-link" target="_blank" rel="noopener noreferrer">
                        <i class="fab fa-github"></i>
                        <span>GitHub</span>
                    </a>
                    <a href="https://github.com/Exios66/FreeWill-HTML/wiki" class="social-link" target="_blank" rel="noopener noreferrer">
                        <i class="fas fa-book"></i>
                        <span>Wiki</span>
                    </a>
                    <a href="https://www.notion.so/" class="social-link" target="_blank" rel="noopener noreferrer">
                        <i class="fas fa-newspaper"></i>
                        <span>Notion</span>
                    </a>
                </div>
            </div>
            
            <div class="footer-right">
                <p>Based on studies by</p>
                <p>Paulhus, D.L., & Carey, J. (2010)</p>
            </div>
        </div>
        
        <div class="footer-divider"></div>
        
        <div class="footer-bottom">
            <p>© 2024 Free Will Synthesis Project. All responses are anonymous.</p>
            <p>Created with <i class="fas fa-heart" style="color: var(--accent-color);"></i> by Exios66</p>
        </div>
    </footer>
</body>
</html>
